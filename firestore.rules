rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Allow reading user documents for login verification and normal access
    match /users/{userId} {
      // Allow reading for login verification (unauthenticated) or if user is authenticated
      allow read: if request.auth == null || request.auth != null;
      
      // Allow creating user documents in these cases:
      // 1. Admin users can create any user document
      // 2. Allow creating user document during login process (when user doesn't exist yet)
      allow create: if request.auth != null && 
        (isAdmin() ||
         request.auth.uid == request.resource.data.uid ||
         exists(/databases/$(database)/documents/users/$(request.auth.uid)) == false);
      
      // Allow updating user documents in these cases:
      // 1. Admin users can update any user document  
      // 2. Users can update their own document (matched by UID in document data)
      allow update: if request.auth != null && 
        (isAdmin() || request.auth.uid == resource.data.uid);
         
      // Only admins can delete user documents
      allow delete: if isAdmin();
    }
    
    // Reminders collection - admins can read/write all, users can read their own
    match /reminders/{reminderId} {
      allow read, write: if request.auth != null && 
        (isAdmin() || resource.data.userId == request.auth.uid);
      allow create: if request.auth != null;
    }
    
    // Subscription Plans collection - only admins can manage
    match /subscriptionPlans/{planId} {
      allow read, write: if isAdmin();
    }
    
    // Shared Accounts collection - only admins can manage
    match /sharedAccounts/{accountId} {
      allow read, write: if isAdmin();
    }
    
    // Account Assignments collection - only admins can manage
    match /accountAssignments/{assignmentId} {
      allow read, write: if isAdmin();
    }
    
    // Deny access to all other documents
    match /{document=**} {
      allow read, write: if false;
    }
  }
}