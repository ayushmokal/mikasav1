rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper to map emails.userId (Firestore user doc id) to the authenticated user
    function isOwnerOfEmailDoc() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(resource.data.userId)) &&
             get(/databases/$(database)/documents/users/$(resource.data.userId)).data.uid == request.auth.uid;
    }
    // Helper function to check if user is admin - more robust version
    function isAdmin() {
      return request.auth != null && 
             request.auth.uid != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Allow reading user documents for login verification and normal access
    match /users/{userId} {
      // Allow reading for login verification (unauthenticated) or if user is authenticated
      allow read: if request.auth == null || request.auth != null;
      
      // Allow creating user documents in these cases:
      // 1. Admin users can create any user document
      // 2. Allow creating user document during login process (when user doesn't exist yet)
      // 3. User creating their own document
      allow create: if request.auth != null && 
        (request.auth.uid == request.resource.data.uid ||
         exists(/databases/$(database)/documents/users/$(request.auth.uid)) == false ||
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
      
      // Allow updating user documents in these cases:
      // 1. Admin users can update any user document  
      // 2. Users can update their own document (matched by UID in document data)
      allow update: if request.auth != null && 
        (request.auth.uid == resource.data.uid || 
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
         
    // Allow deletion for admins
    allow delete: if isAdmin();
    }
    
    // Reminders collection - admins can read/write all, users can read their own
    match /reminders/{reminderId} {
      allow read, write: if request.auth != null && 
        ((exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin') ||
         resource.data.userId == request.auth.uid);
      allow create: if request.auth != null;
    }
    
    // Subscription Plans collection - only admins can manage
    match /subscriptionPlans/{planId} {
      allow read, write: if isAdmin();
    }
    
    // Shared Accounts collection - only admins can manage
    match /sharedAccounts/{accountId} {
      allow read, write: if isAdmin();
    }
    
    // Account Assignments collection - only admins can manage
    match /accountAssignments/{assignmentId} {
      allow read, write: if isAdmin();
    }

    // Emails collection - users can read/update/delete their own email docs
    // Creation is handled by server-side code using Admin SDK (bypasses rules)
    match /emails/{emailId} {
      allow read, update, delete: if isOwnerOfEmailDoc();
      allow create: if false; // prevent client-side creation
    }
    
    // Deny access to all other documents
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
